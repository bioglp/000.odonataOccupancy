---
title: "occupancyOdonata20k"
author: "Gianandrea La Porta"
date: "2025-11-05"
format: 
  html:
    theme: cosmo
    code-fold: true
    code-fold-default: true
    toc: true
execute:
  warning: false
editor: source
editor_options: 
  chunk_output_type: console
---

## Libraries

```{r libraries}
dir.create('input', showWarnings = FALSE)
#dir.create('output', showWarnings = FALSE)
#dir.create('plots', showWarnings = FALSE)
dir.create('R-script', showWarnings = FALSE)
library(rtrim)
library(pacman)
p_load(tidyverse,gt,skimr,ggpubr,
       rstatix,openxlsx,scales, patchwork)
theme_set(theme_bw(base_size = 14))
```

Campi del dataset di partenza filtrato per cellcode2020 (grid 20km):

```{r import data}
year_start <- 2005

dfo <- read.xlsx('input/datasetSegnalazioni_R20251106.xlsx')
dfo <- dfo %>% rename_with(tolower)
dfo <- dfo %>% filter(date_year>=year_start, 
                      date_year<2026, 
                      code=='Continental',
                      !is.na(cellcode20))
dfo <- dfo %>% 
  rename(species=latin_taxon)
glimpse(dfo)#View(dfo)
```

```{r nomiSpecie}
# rinominare specie
# dfo %>% distinct(species) %>% arrange() %>% pull()
dfo$species[dfo$species=='Sympetrum fonscolombei'] <- 'Sympetrum fonscolombii'
dfo$species[dfo$species=='Calopteryx splendens caprai'] <- 'Calopteryx splendens'
dfo$species[dfo$species=='Calopteryx splendens splendens'] <- 'Calopteryx splendens'
dfo$species[dfo$species=='Calopteryx virgo padana'] <- 'Calopteryx virgo'
dfo$species[dfo$species=='Calopteryx virgo meridionalis'] <- 'Calopteryx virgo'
dfo$species[dfo$species=='Calopteryx virgo virgo'] <- 'Calopteryx virgo'
dfo$species[dfo$species=='Gomphus flavipes'] <- 'Stylurus flavipes'
dfo$species[dfo$species=='Lestes virens vestalis'] <- 'Lestes virens'
dfo$species[dfo$species=='Onychogomphus forcipatus unguiculatus'] <- 'Onychogomphus forcipatus'
dfo$species[dfo$species=='Onychogomphus forcipatus forcipatus'] <- 'Onychogomphus forcipatus'
dfo$species[dfo$species=='Oxygastra curtisi'] <- 'Oxygastra curtisii'
dfo$species[dfo$species=='Cordulegaster bidentata bidentata'] <- 'Cordulegaster bidentata'
dfo$species[dfo$species=='Orthetrum coerulescens coerulescens'] <- 'Orthetrum coerulescens'

dfo <- dfo %>% filter(!str_detect(species, "sp\\.$|sp\\s|sp$"))
dfo <- dfo %>% filter(species!='No odonata')
```

La serie dati va dal `r min(dfo$date_year)` al `r max(dfo$date_year)`.

## Sampling efforts

Percentuale di celle visitate ogni anno con almeno 1 segnalazione sul totale complessivo di celle calcolato considerando l'intero periodo `r min(dfo$date_year)`-`r max(dfo$date_year)`.

```{r 'sampling_effort'}
# totale celle
ncell <- dfo %>% 
  distinct(cellcode20) %>% 
  count() %>% pull()

# celle monitorate x anno
cells <- dfo %>% 
  group_by(date_year) %>% 
  distinct(cellcode20)

cells %>% 
  count(date_year) %>% 
  mutate(p=n/ncell) %>% 
  ggplot(aes(date_year,p))+
  geom_area(fill='forestgreen', alpha=0.6)+
  labs(y='no. cells\n', x='')+
  scale_y_continuous(labels = percent_format())
```

## Accumulation curves

```{r sites-species}
mat <- dfo %>%
  group_by(cellcode20, species) %>%
  summarise(count = n(), .groups = "drop") %>%
  pivot_wider(names_from = species, 
              values_from = count, 
              values_fill = 0) %>%
  mutate(cellcode20=paste0('cellcode',cellcode20)) %>% 
  column_to_rownames('cellcode20')
mat_num <- as.matrix(mat)

# Curva di accumulazione usando i conteggi (abbondanza)
library(vegan)
accum <- specaccum(mat_num, method = "random")

# Plot
plot(accum, 
     xlab = "Sites", 
     ylab = "No. of species")
```

### Accumulation by year (groups of 5 years)

```{r accumulation_year}
# Funzione per creare la matrice sito × specie per un anno
make_matrix <- function(df_year) {
  df_year %>%
    group_by(cellcode20, species) %>%
    summarise(count = n(), .groups = "drop") %>%  # conteggio osservazioni
    pivot_wider(names_from = species, 
                values_from = count, values_fill = 0) %>%
    column_to_rownames("cellcode20") %>%
    as.matrix()
}

# Lista degli anni
dfo <- dfo %>%
  mutate(year_group = paste0(floor(date_year / 5) * 5, 
                             "-", floor(date_year / 5) * 5 + 4))
dfo$year_group[dfo$year_group == "2020-2024"] <- "2020-2025"
dfo$year_group[dfo$year_group == "2025-2029"] <- "2020-2025"


# Funzione per creare matrice sito × specie con conteggi
make_matrix <- function(df_group) {
  df_group %>%
    group_by(cellcode20, species) %>%
    summarise(count = n(), .groups = "drop") %>%
    pivot_wider(names_from = species, 
                values_from = count, 
                values_fill = 0) %>%
    mutate(cellcode20=paste0('cellcode',cellcode20)) %>% 
    column_to_rownames("cellcode20") %>%
    as.matrix()
}

# Lista dei gruppi
groups <- sort(unique(dfo$year_group))
accum_list <- list()

for (grp in groups) {
  mat_num <- make_matrix(dfo %>% filter(year_group == grp))
  accum_list[[grp]] <- specaccum(mat_num, method = "random")
}

# Preparare dati per ggplot
plot_data <- bind_rows(lapply(names(accum_list), 
                              function(grp) {
                                data.frame(
                                  sites = accum_list[[grp]]$sites,
                                  species = accum_list[[grp]]$richness,
                                  se = accum_list[[grp]]$sd,
                                  year_group = grp
                                )
                              }), .id = NULL)

# Plot con ggplot
ggplot(plot_data, aes(x = sites, 
                      y = species, 
                      color = factor(year_group))) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = species - se, 
                  ymax = species + se, 
                  fill = factor(year_group)),
              alpha = 0.2, color = NA) +
  labs(x = "\nNo. cells", y = "No. of species\n",
       color = "Years", fill = "Years",
       title = "")+
  theme(legend.position = 'top', 
        legend.direction = 'horizontal')
```

Extrapolated Species Richness in a Species Pool

```{r extrapolated_richness}
pool <- poolaccum(mat_num)
#summary(pool, display = "chao")
plot(pool)
```

```{r norare}
# eliminazione dall'analisi delle specie con meno di 50 occorrenze totali.
listaSpecie <- dfo %>% 
  count(species) %>% 
  filter(n>50) %>% 
  pull(species)

dfo <- dfo %>%
  filter(species %in% listaSpecie)
```

## Linear trends

Plot del numero di celle in cui la specie è stata osservata nel corso degli anni. Il dato non tiene conto dello sforzo di ricerca.

```{r linear_trend, fig.height=5, fig.width=7}
# Numero di siti per specie e anno
species_sites <- dfo %>%
  group_by(species, date_year) %>%
  summarise(n_sites = n_distinct(cellcode20), .groups = "drop")

listaSpecie <- dfo %>% distinct(species) %>% 
  arrange(species) %>% pull() 
sp <- listaSpecie[1]

odoTrend <- function(sp) {
  species_sites %>% 
    filter(species==sp) %>% 
    ggplot(aes(x = date_year, y = n_sites)) +
    geom_smooth(method='lm',col='forestgreen')+
    stat_regline_equation()+
    geom_line(size = 1) +
    geom_point() +
    labs(x = "", 
         y = "No. sites",
         title = sp)+
    theme(plot.title = element_text(face = 'italic'))
  #filename <- paste0("trend/lm_", gsub(" ", "_", sp), ".pdf")
  #ggsave(filename, width = 7, height = 5)
}

lapply(listaSpecie, odoTrend)

library(broom)
# Regressione lineare per tutte le specie
species_trends <- species_sites %>%
  group_by(species) %>%
  do(tidy(lm(n_sites ~ date_year, data = .)))

# Seleziona solo le righe relative a date_year e con pendenza negativa
negative_trends <- species_trends %>%
  filter(term == "date_year", estimate < 0) %>%
  select(species, estimate, std.error, statistic, p.value)

negative_trends
```

## Sampling effort

Per tenere conto anche del differente sforzo di copertura delle celle del territorio nel corso degli anni, il modello lm è stato modificato in glm con una correzione derivante dall'utilizzo di un offset pari al log(n_sites_censiti) per ciascun anno. Il modello normalizza i conteggi per lo sforzo, così che la pendenza stimata per `date_year` rifletta la vera tendenza di espansione o contrazione e non solo la variazione derivante dal differnte sforzo di campionamento.

```{r glm_offset}
# n_sites occupati da ciascuna specie per anno
species_sites <- dfo %>%
  group_by(species, date_year) %>%
  summarise(n_sites = n_distinct(cellcode20), .groups = "drop")

# n_sites monitorati per anno
effort_df <- dfo %>% 
  group_by(date_year) %>%
  distinct(cellcode20) %>% 
  count(date_year, name = 'n_sites_censiti')

species_sites <- species_sites %>%
  left_join(effort_df, by = "date_year")

results <- species_sites %>%
  group_by(species) %>%
  do({
    mod <- glm(n_sites ~ date_year, family = quasipoisson,
               offset = log(n_sites_censiti), data = .)
    tidy(mod)  # restituisce coefficienti, SE, p-value
  }) %>%
  ungroup()

species_trends <- results %>%
  filter(term == "date_year") %>%
  mutate(trend = case_when(
    estimate > 0 ~ "increase",
    estimate < 0 ~ "decrease",
    TRUE ~ "stable"
  ))
```

Le specie che mostrano trend negativi significativi sono:

```{r negative-trends}
# Seleziona solo le righe con pendenza negativa
negative_trends <- species_trends %>%
  filter(term == "date_year", estimate < 0, p.value<0.05) %>%
  select(species, estimate, std.error, statistic, p.value, trend)

print(negative_trends, n = 20)
```

Grafico dei trend significativi

```{r trends, fig.height=12, fig.width=7}
# Grafico a barre con specie ordinate per stima significativa
# Le altre specie sono stabili
species_trends %>% 
  filter(!is.na(estimate), p.value<0.05) %>% 
  ggplot(aes(x = reorder(species, estimate), 
             y = estimate, fill = trend)) +
  geom_col() +
  coord_flip() +  # barre orizzontali per leggibilità
  labs(
    x = "",
    y = "glm slope",
    fill = "Trend",
    title = ""
  ) +
  scale_fill_manual(values = c("increase" = "forestgreen",
                               "stable" = "gray70",
                               "decrease" = "red"))+
  theme(legend.position = 'top',
        axis.text.y = element_text(face='italic'))
```

Modello glm(family=quasipoisson) per la stima del numero di celle attese per ciascun anno e analisi degli scarti. I punti rappresentano i valori osservati.

```{r glm_pred, fig.width=12, fig.height=5}
# Generare valori predetti per ciascuna specie
# single species
sp_tmp <- species_sites %>% 
  dplyr::filter(species==listaSpecie[2])
# mod1 <- glm.nb(n_sites ~ date_year + offset(log(n_sites_censiti)), 
#                      data = sp_tmp)  
mod2 <- glm(n_sites ~ date_year, family = poisson,
            offset = log(n_sites_censiti), data = sp_tmp)
mod3 <- glm(n_sites ~ date_year, family = quasipoisson,
            offset = log(n_sites_censiti), data = sp_tmp)
#mod2;mod3

predicted_sites <- species_sites %>%
  drop_na(n_sites, n_sites_censiti, date_year) %>% 
  group_by(species) %>%
  do({
    mod <- glm(n_sites ~ date_year, family = quasipoisson,
               offset = log(n_sites_censiti), data = .)
    data.frame(date_year = .$date_year,
               pred = predict(mod, type = "response"))
  }) %>%
  ungroup()

predicted_sites <- predicted_sites%>% 
  left_join(species_sites)

# Grafici aree-linee per specie
odoTrendE <- function(sp) {
  P <- predicted_sites %>% 
    filter(species == sp) %>%
    mutate(res=n_sites-pred) %>% 
    ggplot(aes(x = date_year, y = pred)) +
    geom_area(fill = 'forestgreen', alpha = 0.7)+
    geom_segment(
      aes(x = date_year, xend = date_year, y = n_sites, yend = pred),
      linetype = "dashed", col='forestgreen'
    ) +
    geom_point(aes(y = n_sites), size = 2) +
    labs(x = "", y = "No. sites", title = sp) +
    theme(plot.title = element_text(face = 'italic'))
  R <- predicted_sites %>% 
    filter(species == sp) %>%
    mutate(res=n_sites-pred) %>% 
    ggplot(aes(x = date_year, y = res)) +
    geom_smooth(col='black')+
    geom_line(col = 'forestgreen', size=1.5)+
    labs(x = "", title = "Residuals", y='') +
    theme(plot.title = element_text(face = 'italic')) 
  P + R
  # filename <- paste0("trend/glm_", gsub(" ", "_", sp), ".pdf")
  # ggsave(filename, width = 13, height = 5)
}
# odoTrendE('Aeshna affinis')
# odoTrendE('Trithemis annulata')

lapply(listaSpecie, odoTrendE)
```

## Uso di TRIM

Il dato utilizzato per la modellistica è il numero di occorrenze per cella per ciascun anno.

```{r TRIM}
odoTrim <- function(nomeSp) {
  
  # Filter data for the species
  df.test <- dfo %>% 
    filter(species == nomeSp) %>% 
    group_by(date_year, cellcode20) %>% 
    count(name = 'count') #occorrenze
  #  summarise(count=sum(total_count), #abbondanze
  #    .groups = 'drop')
  
  # Check: at least 3 years
  if (n_distinct(df.test$date_year) < 3) {
    message("Not enough years for ", nomeSp, " — skipped")
    return(NULL)
  }
  # Check: at least 3 sites
  if (n_distinct(df.test$cellcode20) < 3) {
    message("Not enough sites for ", nomeSp, " — skipped")
    return(NULL)
  }
  # Try to fit TRIM
  res <- tryCatch({
    m3 <- trim(count ~ cellcode20 + date_year, 
               data = df.test, 
               model = 3)
    out <- overall(m3)
    out$slope$species=nomeSp
    # Filename
    filename <- paste0("trim/trim_", gsub(" ", "_", nomeSp), ".pdf")
    # Save PDF
    #pdf(filename, width = 7, height = 5)
    plot(overall(m3), main = paste0(nomeSp,' - ',overall(m3)$slope$meaning))
    #dev.off()
    message("✅   Completed: ", nomeSp)
    return(out)
  }, error = function(e) {
    message("❌   FAILED for ", nomeSp, ": ", e$message)
    return(NULL)
  })
  return(res)
}

# # test su singole specie
# odoTrim("Aeshna affinis")
# odoTrim(listaSpecie[77])
results <- lapply(listaSpecie, odoTrim)
```

```{r trim_tab}
# Tabella con tutte le specie e relativi plot
results_df <- do.call(bind_rows, lapply(results, function(x) x$slope))
gt(results_df)%>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 2
  )
#write.csv(results_df,'trim/trimResults.csv')
```

## Modelli di occupancy con unmarked

### Modello colext

Il modello utilizzato è del tipo Dynamic occupancy models [colext](https://cran.r-project.org/web/packages/unmarked/vignettes/colext.html). La formula impiegata è `colext(~1, ~1, ~1, ~effort, umf2` e considera una p in funzione dell'effort e una ψ (probabilità di occupazione), gamma (probabilità di colonizzazione - in blu), epsilon (probabilità di estinzione in rosso) costanti.

```{r unmarked}
library(unmarked)
years <- year_start:2025
#nomeSp <- 'Aeshna affinis'

effort_vec <- effort_df %>% 
  pull(n_sites_censiti)

# celle visitate area di studio
df.occuTot <- dfo %>% 
  select(date_year,cellcode20) %>% as_tibble() %>% 
  count(cellcode20,date_year, name = 'n_occurrences')

# filtro delle specie con meno di 50 records totali
# cfr. (Rapacciuolo et al. 2017)

listaSpecie <- dfo %>% 
  count(species) %>% 
  filter(n>=50) %>% 
  pull(species)

occProb <- function(nomeSp) {
  #print(nomeSp)
  
  # celle delle specie
  df.occu <- dfo %>% 
    filter(species==nomeSp) %>% 
    select(date_year,species,cellcode20) %>% as_tibble() %>% 
    count(cellcode20,species,date_year, name = 'n_occurrences')
  
  # stima presenza/pseudo-assenza e celle non visitate
  occupafun <- function(df.occu) {
    df_occ <- df.occuTot %>% 
      select(-n_occurrences) %>% 
      left_join(df.occu, by = c("cellcode20", "date_year"), ) %>%
      mutate(presence = replace_na(n_occurrences, 0)) %>%
      mutate(presence = ifelse(presence>0,1,0)) %>%
      select(cellcode20, date_year, presence) %>% 
      complete(cellcode20,date_year,
               fill = list(presence=NA))
    return(df_occ)
  }
  
  # if (nomeSp == "Trithemis annulata") {
  #   df_sp <- df_sp %>% filter(date_year > 2016)
  #   effort_vec <- effort_vec[13:21] # ATTENZIONE SE CAMBIA year_start
  #   years <- 2017:2025
  # }
  df_sp <- occupafun(df.occu)
  
  detection_matrix <- df_sp %>%
    pivot_wider(names_from = date_year, 
                values_from = presence, 
                values_fill = NA) %>%
    arrange(cellcode20)
  # Conversione in oggetto umf
  y <- as.matrix(detection_matrix[,-1])
  effort_matrix <- matrix(rep(effort_vec, 
                              each = nrow(y)), 
                          nrow = nrow(y))
  rownames(y) <- detection_matrix$cellcode20
  umf <- unmarkedFrameOccu(y = y, obsCovs = list(effort = effort_matrix))
  fm <- occu(~effort ~1, data = umf)
  
  years_vec <- factor(year_start:2025)
  years <- matrix(years_vec, 
                  nrow(effort_matrix), 
                  21, 
                  byrow=TRUE)
  umf2 <- unmarkedMultFrame(y=y,
                            yearlySiteCovs=list(year=years),
                            obsCovs=list(effort = effort_matrix),
                            numPrimary=21)
  fm2 <- colext(~1, ~1, ~1, ~effort, umf2)
  #summary(fm2)
  
  make_umf_3years <- function(y, effort, start_index) {
    idx <- start_index:(start_index + 2)  # 3 anni
    
    y_sub <- y[, idx]
    eff_sub <- effort[, idx]
    
    unmarkedMultFrame(
      y = y_sub,
      obsCovs = list(effort = eff_sub),
      numPrimary = 3
    )
  }
  
  results_3yr <- lapply(1:(ncol(y) - 2), function(i) {
    
    umf_i <- make_umf_3years(y, effort_matrix, i)
    
    fm_i <- try(
      colext(
        psiformula   = ~1,
        gammaformula = ~1,
        epsilonformula = ~1,
        pformula     = ~effort,
        data = umf_i
      ),
      silent = TRUE
    )
    
    # se modello fallisce
    if (inherits(fm_i, "try-error")) {
      return(data.frame(
        window_start = years_vec[i],
        window_end   = years_vec[i + 2],
        psi = NA,
        gamma = NA,
        epsilon = NA
      ))
    }
    
    # estrai stime
    data.frame(
      species = nomeSp,
      window_start = years_vec[i],
      window_end   = years_vec[i + 2],
      psi     = backTransform(fm_i, "psi")@estimate,
      gamma   = backTransform(fm_i, "col")@estimate,
      epsilon = backTransform(fm_i, "ext")@estimate
    )
  })
  
  dyn3 <- do.call(rbind, results_3yr)
  dyn3
  
  return(data = dyn3)
}

# listaSpecie
# occProb("Trithemis annulata")
results <- map(listaSpecie, occProb)
all_species_df <- bind_rows(results)
```

```{r groupYears}
all_species_df <- all_species_df %>%
  mutate(year_group = paste0(floor(as.numeric(as.character(all_species_df$window_end)) / 3) * 3, 
                             "-", floor(as.numeric(as.character(all_species_df$window_end)) / 3) * 3 + 2))
all_species_df$year_group[all_species_df$year_group == "2022-2024"] <- "2022-2025"
all_species_df$year_group[all_species_df$year_group == "2025-2027"] <- "2022-2025"

geometric_mean <- function(x) exp(mean(log(x[x > 0]), 
                                       na.rm = TRUE))
```

```{r unmarked_plot, fig.width=12, fig.height=5}
occu.plot <- function(nomeSp){
  plot1 <- all_species_df %>% 
    filter(species==nomeSp) %>% 
    rename(year=window_end) %>% 
    ggplot(aes(year, psi, group = 1, col=year_group)) +
    geom_smooth(col='black')+
    geom_point(size = 4) +
    geom_line(aes(y=gamma), col='steelblue', 
              size = 1, 
              alpha=0.4) +
    geom_line(aes(y=epsilon), col='red', 
              size = 1, 
              alpha=0.4) +
    labs(
      title=nomeSp,
      x = ""
    ) +
    ylim(0,1)+
    scale_color_viridis_d(direction = -1)+
    theme_minimal(base_size = 13)+
    theme(legend.position='none',
          plot.title = element_text(face = 'italic'),
          axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
  
  plot5 <- all_species_df %>% 
    filter(species==nomeSp) %>% 
    group_by(year_group) %>% 
    summarise(year=max(as.numeric(as.character(window_end))),
              mean.psi=geometric_mean(psi),
              mean.gamma=geometric_mean(gamma),
              mean.eps=geometric_mean(epsilon)) %>% 
    ggplot(aes(year, mean.psi, group = 1, col=year_group)) +
    geom_smooth(col='black')+
    geom_point(size = 4) +
    geom_line(aes(y=mean.gamma), col='steelblue', 
              size = 1, 
              alpha=0.4) +
    geom_line(aes(y=mean.eps), col='red', 
              size = 1, 
              alpha=0.4) +
    labs(
      title='geometric mean',
      x = ""
    ) +
    ylim(0,1)+
    scale_color_viridis_d(direction = -1)+
    theme_minimal(base_size = 13)+
    theme(legend.position='none',
          plot.title = element_text(face = 'italic'))
  
  plot1+plot5
}

#nomeSp='Trithemis annulata'
#occu.plot(nomeSp)
map(listaSpecie,occu.plot)
```

### Modello pcount

```{r abundance}
glimpse(dfo)
dfp <- dfo |> 
  group_by(date_year,species,cellcode20) |> 
  select(total_count) |> 
  summarise(total_count=sum(total_count, na.rm=T)) |> 
  arrange(species,date_year,cellcode20) |>
  ungroup()
```

```{r pcount, include=FALSE, echo=F}
df_sp <- dfp %>% filter(species == "Aeshna affinis")
df_sp
y_wide <- df_sp %>%
  select(-species) |>  
  pivot_wider(id_cols = cellcode20, 
  names_from = date_year, values_from = total_count)

y <- as.matrix(y_wide[,-1])
rownames(y) <- y_wide$cellcode20

library(unmarked)
# Creo l'oggetto unmarkedFramePCount
umf <- unmarkedFramePCount(y = y) 
years <- as.numeric(colnames(y))

obs_year <- matrix(rep(years, each = nrow(y)), nrow = nrow(y))

umf <- unmarkedFramePCount(
  y = y,
  obsCovs = list(year = obs_year)
)

# pcount
fm1 <- pcount(~ year ~ 1, data = umf, mixture = "P", K=100)
summary(fm1)

newdat <- data.frame(year = years)

pred <- predict(
  fm1,
  type = "state",     # abbondanza stimata
  newdata = newdat
)

pred_df <- data.frame(
  year = years,
  estimate = pred$Predicted,
  lower = pred$lower,
  upper = pred$upper
)

ggplot(pred_df, aes(x = year, y = estimate)) +
  geom_line(color = "#2c7bb6", linewidth = 1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, 
              fill = "#2c7bb6") +
  labs(
    title = paste("Trend di abbondanza stimata –", sp),
    x = "Anno",
    y = "Abbondanza stimata (± IC 95%)"
  ) +
  theme_minimal(base_size = 14)


umf <- unmarkedFramePCount(
  y = as.matrix(df_sp$total_count),
  siteCovs = data.frame(year = df_sp$date_year, cell = df_sp$cellcode20)
)

fm2 <- pcount(~1 ~ year, data = umf, mixture = "P", K = max(df_sp$total_count) + 20)
summary(fm2)

newdat <- data.frame(year = seq(min(df_sp$date_year), max(df_sp$date_year)))
pred <- predict(fm2, type = "state", newdata = newdat)

pred_df <- data.frame(
  year = newdat$year,
  estimate = pred$Predicted,
  lower = pred$lower,
  upper = pred$upper
)

library(ggplot2)
ggplot(pred_df, aes(x = year, y = estimate)) +
  geom_line(color = "#2c7bb6", linewidth = 1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#2c7bb6", alpha = 0.2) +
  labs(
    title = "Trend stimato di abbondanza – Luscinia megarhynchos",
    x = "Anno",
    y = "Abbondanza stimata (± IC 95%)"
  ) +
  theme_minimal(base_size = 14)

```